<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mission Control - SpaceWatch Admin</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f2f3f3;
      --border:#d5dbdb;
      --muted:#545b64;
      --text:#16191f;
      --danger:#d13212;
      --dangerBg:rgba(209,50,18,.1);
      --dangerBorder:#d13212;
      --warning:#ff9900;
      --warningBg:rgba(255,153,0,.1);
      --warnBorder:#ff9900;
      --info:#0073bb;
      --infoBg:rgba(0,115,187,.1);
      --ok:#1d8102;
      --okBg:rgba(29,129,2,.1);
      --okBorder:#1d8102;
      --accent:#0073bb;
      --accentHover:#005a9e;
      --accentLight:#e6f2f8;
      --doBlue:#0069ff;
      --doBlueLight:#e6f0ff;
      --doBlueDark:#003d99;
      --gradientStart:#e6f0ff;
      --gradientMid:#f0f7ff;
      --gradientEnd:#ffffff;
    }
    * { box-sizing: border-box; }
    body{
      font-family: system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, var(--gradientStart) 0%, var(--gradientMid) 25%, var(--gradientEnd) 50%, var(--gradientMid) 75%, var(--gradientStart) 100%);
      background-attachment: fixed;
      color: var(--text);
      margin:0;
      padding:20px;
      min-height: 100vh;
    }
    .wrap{ max-width: 1400px; margin:0 auto; }
    
    /* Header */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:24px;
      flex-wrap:wrap;
      gap:16px;
    }
    h1{
      margin:0;
      font-size:28px;
      font-weight:700;
      letter-spacing:-.5px;
      color:var(--text);
    }
    .subtitle{
      color:var(--muted);
      font-size:14px;
      margin-top:4px;
    }
    
    /* Security Token Input */
    .security-token-section{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .security-token-input{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:6px;
      padding:8px 12px;
      color:var(--text);
      font-size:14px;
      width:240px;
    }
    .api-key-input:focus{
      outline:none;
      border-color:var(--accent);
    }
    .btn{
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:6px;
      padding:8px 16px;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:background .2s;
    }
    .btn:hover{
      background:var(--accentHover);
    }
    .btn-sm{
      padding:6px 12px;
      font-size:13px;
    }
    
    /* Status Bar */
    .status-bar{
      background:#ffffff;
      border:1px solid rgba(0, 105, 255, 0.2);
      border-radius:8px;
      padding:20px;
      margin-bottom:24px;
      display:flex;
      gap:32px;
      align-items:center;
      flex-wrap:wrap;
      box-shadow: 0 2px 12px rgba(0, 105, 255, 0.15);
    }
    .status-pill{
      padding:6px 16px;
      border-radius:20px;
      font-size:14px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .status-healthy{
      background:var(--okBg);
      color:var(--ok);
      border:1px solid var(--ok);
    }
    .status-degraded{
      background:var(--warningBg);
      color:var(--warning);
      border:1px solid var(--warning);
    }
    .status-down{
      background:var(--dangerBg);
      color:var(--danger);
      border:1px solid var(--danger);
    }
    .metric-box{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .metric-label{
      color:var(--muted);
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .metric-value{
      font-size:24px;
      font-weight:700;
      color:var(--text);
    }
    .metric-unit{
      font-size:14px;
      font-weight:400;
      color:var(--muted);
      margin-left:4px;
    }
    
    /* Grid Layout */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(400px,1fr));
      gap:20px;
      margin-bottom:24px;
    }
    .card{
      background:#ffffff;
      border:1px solid rgba(0, 105, 255, 0.2);
      border-radius:8px;
      padding:20px;
      box-shadow: 0 2px 12px rgba(0, 105, 255, 0.15);
    }
    .card-title{
      font-size:16px;
      font-weight:600;
      margin:0 0 16px;
      color:var(--text);
    }
    
    /* Chart */
    #chart-container{
      width:100%;
      height:300px;
      position:relative;
    }
    
    /* Events Feed */
    .event-item{
      background:rgba(0, 105, 255, .03);
      border-left:3px solid var(--border);
      border-radius:4px;
      padding:12px;
      margin-bottom:8px;
    }
    .event-item.severity-disaster{
      border-left-color:var(--danger);
      background:var(--dangerBg);
    }
    .event-item.severity-high{
      border-left-color:var(--warning);
      background:var(--warningBg);
    }
    .event-item.severity-warning{
      border-left-color:var(--warning);
      background:var(--warningBg);
    }
    .event-item.severity-info{
      border-left-color:var(--info);
      background:var(--infoBg);
    }
    .event-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }
    .event-title{
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }
    .event-badge{
      font-size:11px;
      padding:3px 8px;
      border-radius:10px;
      font-weight:600;
      text-transform:uppercase;
    }
    .badge-disaster{
      background:var(--dangerBg);
      color:var(--danger);
    }
    .badge-high{
      background:var(--warningBg);
      color:var(--warning);
    }
    .badge-warning{
      background:var(--warningBg);
      color:var(--warning);
    }
    .badge-info{
      background:var(--infoBg);
      color:var(--info);
    }
    .event-details{
      font-size:13px;
      color:var(--muted);
    }
    .event-time{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }
    
    /* Tables */
    .table-container{
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th{
      text-align:left;
      padding:8px;
      border-bottom:1px solid var(--border);
      color:var(--muted);
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    td{
      padding:8px;
      border-bottom:1px solid rgba(42,49,66,.5);
      color:var(--text);
    }
    tr:last-child td{
      border-bottom:none;
    }
    .route-cell{
      font-family:monospace;
      font-size:12px;
      color:var(--doBlue);
    }
    
    /* Loading & Error States */
    .loading{
      text-align:center;
      padding:40px;
      color:var(--muted);
    }
    .error{
      background:var(--dangerBg);
      border:1px solid var(--danger);
      border-radius:6px;
      padding:12px;
      color:var(--danger);
      margin-bottom:16px;
    }
    .empty{
      text-align:center;
      padding:20px;
      color:var(--muted);
      font-size:14px;
    }
    
    /* Pagination & Filters */
    .filter-bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      gap:12px;
      flex-wrap:wrap;
    }
    .filter-buttons{
      display:flex;
      gap:8px;
    }
    .filter-btn{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:6px;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      cursor:pointer;
      transition:all .2s;
      color:var(--text);
    }
    .filter-btn:hover{
      background:var(--accentLight);
      border-color:var(--accent);
    }
    .filter-btn.active{
      background:var(--doBlue);
      color:#fff;
      border-color:var(--doBlue);
    }
    .pagination{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .page-btn{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:6px;
      padding:6px 12px;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
      transition:all .2s;
      color:var(--text);
    }
    .page-btn:hover:not(:disabled){
      background:var(--accentLight);
      border-color:var(--accent);
    }
    .page-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .page-info{
      font-size:12px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="header">
      <div>
        <h1>üöÄ Mission Control</h1>
        <div class="subtitle">SpaceWatch Admin Dashboard</div>
      </div>
      <div class="security-token-section">
        <input type="password" id="securityTokenInput" class="security-token-input" placeholder="Enter Security Token" />
        <button class="btn btn-sm" onclick="saveSecurityToken()">Save</button>
        <button class="btn btn-sm" onclick="refreshDashboard()">Refresh</button>
      </div>
    </div>
    
    <!-- Error Display -->
    <div id="errorDisplay" style="display:none;" class="error"></div>
    
    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
      <span class="status-pill status-healthy" id="statusPill">LOADING...</span>
      <div class="metric-box">
        <div class="metric-label">Uptime</div>
        <div class="metric-value" id="uptime">--</div>
      </div>
      <div class="metric-box">
        <div class="metric-label">Req/Min (1m)</div>
        <div class="metric-value"><span id="reqPerMin1m">--</span><span class="metric-unit">req/m</span></div>
      </div>
      <div class="metric-box">
        <div class="metric-label">P95 Latency (5m)</div>
        <div class="metric-value"><span id="p95Latency">--</span><span class="metric-unit">ms</span></div>
      </div>
      <div class="metric-box">
        <div class="metric-label">5xx Rate (5m)</div>
        <div class="metric-value"><span id="error5xxRate">--</span><span class="metric-unit">%</span></div>
      </div>
      <div class="metric-box">
        <div class="metric-label">Active Users (30m)</div>
        <div class="metric-value" id="activeUsers">--</div>
      </div>
    </div>
    
    <!-- Chart -->
    <div class="card" style="margin-bottom:24px;">
      <h3 class="card-title">üìä Time Series (Last 60m)</h3>
      <div id="chart-container">
        <svg id="chart" width="100%" height="100%"></svg>
      </div>
    </div>
    
    <!-- Grid for Events and Tables -->
    <div class="grid">
      <!-- Events Feed -->
      <div class="card">
        <h3 class="card-title">‚ö° What Changed?</h3>
        <div class="filter-bar">
          <div class="filter-buttons">
            <button class="filter-btn active" data-severity="all" onclick="filterEvents('all')">All</button>
            <button class="filter-btn" data-severity="info" onclick="filterEvents('info')">Info</button>
            <button class="filter-btn" data-severity="warning" onclick="filterEvents('warning')">Warning</button>
            <button class="filter-btn" data-severity="critical" onclick="filterEvents('critical')">Critical</button>
          </div>
        </div>
        <div id="eventsFeed" class="loading">Loading events...</div>
        <div class="pagination" id="eventsPagination" style="display:none; margin-top:12px;">
          <button class="page-btn" onclick="previousEventsPage()">Previous</button>
          <span class="page-info" id="eventsPageInfo"></span>
          <button class="page-btn" onclick="nextEventsPage()">Next</button>
        </div>
      </div>
      
      <!-- Top Endpoints by Volume -->
      <div class="card">
        <h3 class="card-title">üìà Top Endpoints (Volume)</h3>
        <div id="topVolume" class="loading">Loading...</div>
      </div>
    </div>
    
    <!-- More Tables -->
    <div class="grid">
      <!-- Slowest Endpoints -->
      <div class="card">
        <h3 class="card-title">üêå Slowest Endpoints (P95)</h3>
        <div id="slowest" class="loading">Loading...</div>
      </div>
      
      <!-- Error-Prone Endpoints -->
      <div class="card">
        <h3 class="card-title">‚ùå Error-Prone Endpoints (5xx)</h3>
        <div id="errorProne" class="loading">Loading...</div>
      </div>
    </div>
  </div>
  
  <script>
    // Security Token Configuration
    let SECURITY_TOKEN = localStorage.getItem('missionControlSecurityToken') || '';
    
    if (SECURITY_TOKEN) {
      document.getElementById('securityTokenInput').value = SECURITY_TOKEN;
    }
    
    function saveSecurityToken() {
      const input = document.getElementById('securityTokenInput');
      SECURITY_TOKEN = input.value.trim();
      if (SECURITY_TOKEN) {
        localStorage.setItem('missionControlSecurityToken', SECURITY_TOKEN);
        showError('Security Token saved!', false);
        refreshDashboard();
      } else {
        showError('Please enter a security token');
      }
    }
    
    function showError(message, isError = true) {
      const errorDiv = document.getElementById('errorDisplay');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      errorDiv.style.background = isError ? 'var(--dangerBg)' : 'var(--okBg)';
      errorDiv.style.borderColor = isError ? 'var(--danger)' : 'var(--ok)';
      errorDiv.style.color = isError ? 'var(--danger)' : 'var(--ok)';
      
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }
    
    async function fetchWithAuth(url) {
      if (!SECURITY_TOKEN) {
        throw new Error('Security token not configured');
      }
      
      const response = await fetch(url, {
        headers: {
          'X-API-Key': SECURITY_TOKEN
        }
      });
      
      if (!response.ok) {
        if (response.status === 401) {
          throw new Error('Invalid security token');
        }
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return response.json();
    }
    
    // Format uptime
    function formatUptime(seconds) {
      const days = Math.floor(seconds / 86400);
      const hours = Math.floor((seconds % 86400) / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      
      if (days > 0) return `${days}d ${hours}h`;
      if (hours > 0) return `${hours}h ${mins}m`;
      return `${mins}m`;
    }
    
    // Format timestamp
    function formatTimestamp(ts) {
      const date = new Date(ts * 1000);
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
      return date.toLocaleString();
    }
    
    // Update overview
    async function updateOverview() {
      try {
        const data = await fetchWithAuth('/admin/api/mission-control');
        
        // Update status
        const statusPill = document.getElementById('statusPill');
        statusPill.textContent = data.status.toUpperCase();
        statusPill.className = 'status-pill status-' + data.status;
        
        // Update metrics
        document.getElementById('uptime').textContent = formatUptime(data.uptime_seconds);
        document.getElementById('reqPerMin1m').textContent = data.now.req_per_min_1m.toFixed(1);
        document.getElementById('p95Latency').textContent = data.now.p95_latency_5m.toFixed(0);
        document.getElementById('error5xxRate').textContent = data.now.error_5xx_rate_5m.toFixed(2);
        document.getElementById('activeUsers').textContent = data.users.unique_sessions_30m;
        
        // Update events
        updateEvents(data.events);
        
        // Update tables
        updateTopVolume(data.top_endpoints.by_volume);
        updateSlowest(data.top_endpoints.slowest);
        updateErrorProne(data.top_endpoints.error_prone);
        
      } catch (error) {
        showError(error.message);
      }
    }
    
    // Events state
    let allEvents = [];
    let filteredEvents = [];
    let currentFilter = 'all';
    let currentPage = 1;
    const eventsPerPage = 5;
    
    // Update events feed
    function updateEvents(events) {
      allEvents = events || [];
      
      // Apply current filter
      filterEvents(currentFilter);
    }
    
    // Filter events by severity
    function filterEvents(severity) {
      currentFilter = severity;
      currentPage = 1;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.severity === severity) {
          btn.classList.add('active');
        }
      });
      
      // Filter events
      if (severity === 'all') {
        filteredEvents = [...allEvents];
      } else if (severity === 'critical') {
        // Map disaster and high to critical
        filteredEvents = allEvents.filter(e => e.severity === 'disaster' || e.severity === 'high');
      } else {
        filteredEvents = allEvents.filter(e => e.severity === severity);
      }
      
      // Reverse to show most recent first
      filteredEvents = filteredEvents.reverse();
      
      renderEventsPage();
    }
    
    // Navigate to next page
    function nextEventsPage() {
      const totalPages = Math.ceil(filteredEvents.length / eventsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderEventsPage();
      }
    }
    
    // Navigate to previous page
    function previousEventsPage() {
      if (currentPage > 1) {
        currentPage--;
        renderEventsPage();
      }
    }
    
    // Render current page of events
    function renderEventsPage() {
      const container = document.getElementById('eventsFeed');
      const paginationDiv = document.getElementById('eventsPagination');
      const pageInfoSpan = document.getElementById('eventsPageInfo');
      
      if (filteredEvents.length === 0) {
        container.innerHTML = '<div class="empty">No events detected</div>';
        paginationDiv.style.display = 'none';
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredEvents.length / eventsPerPage);
      const startIdx = (currentPage - 1) * eventsPerPage;
      const endIdx = Math.min(startIdx + eventsPerPage, filteredEvents.length);
      const pageEvents = filteredEvents.slice(startIdx, endIdx);
      
      // Render events
      let html = '';
      for (const event of pageEvents) {
        html += `
          <div class="event-item severity-${event.severity}">
            <div class="event-header">
              <div class="event-title">${event.title}</div>
              <span class="event-badge badge-${event.severity}">${event.severity}</span>
            </div>
            <div class="event-details">${event.details}</div>
            <div class="event-time">${formatTimestamp(event.ts)}</div>
          </div>
        `;
      }
      
      container.innerHTML = html;
      
      // Update pagination
      if (totalPages > 1) {
        paginationDiv.style.display = 'flex';
        pageInfoSpan.textContent = `Page ${currentPage} of ${totalPages}`;
        
        // Update button states
        const prevBtn = paginationDiv.querySelector('.page-btn:first-child');
        const nextBtn = paginationDiv.querySelector('.page-btn:last-child');
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
      } else {
        paginationDiv.style.display = 'none';
      }
    }
    
    // Update top volume table
    function updateTopVolume(routes) {
      const container = document.getElementById('topVolume');
      
      if (!routes || routes.length === 0) {
        container.innerHTML = '<div class="empty">No data</div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr><th>Route</th><th>Count</th><th>Req/Min</th></tr></thead><tbody>';
      
      for (const route of routes) {
        html += `
          <tr>
            <td class="route-cell">${route.route}</td>
            <td>${route.count}</td>
            <td>${route.req_per_min.toFixed(1)}</td>
          </tr>
        `;
      }
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    // Update slowest table
    function updateSlowest(routes) {
      const container = document.getElementById('slowest');
      
      if (!routes || routes.length === 0) {
        container.innerHTML = '<div class="empty">No data</div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr><th>Route</th><th>P95 (ms)</th><th>Count</th></tr></thead><tbody>';
      
      for (const route of routes) {
        html += `
          <tr>
            <td class="route-cell">${route.route}</td>
            <td>${route.p95_latency_ms}</td>
            <td>${route.count}</td>
          </tr>
        `;
      }
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    // Update error-prone table
    function updateErrorProne(routes) {
      const container = document.getElementById('errorProne');
      
      if (!routes || routes.length === 0) {
        container.innerHTML = '<div class="empty">No errors detected üéâ</div>';
        return;
      }
      
      let html = '<div class="table-container"><table><thead><tr><th>Route</th><th>5xx Count</th><th>Error Rate</th></tr></thead><tbody>';
      
      for (const route of routes) {
        html += `
          <tr>
            <td class="route-cell">${route.route}</td>
            <td>${route.error_5xx_count}</td>
            <td>${route.error_5xx_rate}%</td>
          </tr>
        `;
      }
      
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }
    
    // Update time series chart
    async function updateTimeSeries() {
      try {
        const data = await fetchWithAuth('/admin/api/timeseries?window=60m&resolution=1m');
        renderChart(data);
      } catch (error) {
        console.error('Failed to update timeseries:', error);
      }
    }
    
    // Simple SVG bar chart renderer
    function renderChart(data) {
      const svg = document.getElementById('chart');
      const container = document.getElementById('chart-container');
      const width = container.clientWidth;
      const height = 300;
      
      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
      
      // Clear existing
      svg.innerHTML = '';
      
      if (!data.timestamps || data.timestamps.length === 0) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', width / 2);
        text.setAttribute('y', height / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('fill', 'var(--muted)');
        text.textContent = 'No data available';
        svg.appendChild(text);
        return;
      }
      
      // Margins
      const margin = { top: 20, right: 20, bottom: 30, left: 60 };
      const chartWidth = width - margin.left - margin.right;
      const chartHeight = height - margin.top - margin.bottom;
      
      // Constants for chart rendering
      const Y_AXIS_USABLE_HEIGHT_RATIO = 0.9; // Leave 10% padding at top for value labels
      const DECIMAL_PRECISION = 1; // Number of decimal places for fractional values
      const TIME_FORMAT_LENGTH = 5; // Length of 'HH:MM' format
      const TIME_PATTERN = /(\d{2}:\d{2})/; // Regex pattern for extracting HH:MM format
      
      // Helper function to format chart values (whole vs decimal)
      const formatChartValue = (value) => {
        return (value % 1 === 0) ? value.toFixed(0) : value.toFixed(DECIMAL_PRECISION);
      };
      
      // Helper function to format timestamps consistently
      const formatTimestamp = (timestamp, formatType = 'full') => {
        if (typeof timestamp === 'number') {
          const date = new Date(timestamp * 1000);
          if (formatType === 'time') {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hourCycle: 'h23' });
          } else {
            return date.toLocaleString('en-US', { 
              month: '2-digit', 
              day: '2-digit', 
              hour: '2-digit', 
              minute: '2-digit', 
              hourCycle: 'h23' 
            });
          }
        } else if (typeof timestamp === 'string') {
          const timeMatch = timestamp.match(TIME_PATTERN);
          if (timeMatch) {
            return timeMatch[1];
          } else {
            const parts = timestamp.split(' ');
            if (parts.length > 1 && parts[1].length >= TIME_FORMAT_LENGTH) {
              return parts[1].substring(0, TIME_FORMAT_LENGTH);
            }
          }
        }
        return '';
      };
      
      // Find max values for scaling
      const maxReq = Math.max(...data.requests_per_min, 1);
      
      // Draw axes
      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.setAttribute('transform', `translate(${margin.left},${margin.top})`);
      
      // Y-axis line
      const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      yAxis.setAttribute('x1', 0);
      yAxis.setAttribute('y1', 0);
      yAxis.setAttribute('x2', 0);
      yAxis.setAttribute('y2', chartHeight);
      yAxis.setAttribute('stroke', 'var(--border)');
      yAxis.setAttribute('stroke-width', 2);
      g.appendChild(yAxis);
      
      // X-axis line
      const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      xAxis.setAttribute('x1', 0);
      xAxis.setAttribute('y1', chartHeight);
      xAxis.setAttribute('x2', chartWidth);
      xAxis.setAttribute('y2', chartHeight);
      xAxis.setAttribute('stroke', 'var(--border)');
      xAxis.setAttribute('stroke-width', 2);
      g.appendChild(xAxis);
      
      // Y-axis labels (5 ticks)
      const numYTicks = 5;
      // Helper function to get nice round numbers for Y-axis
      const getNiceNumber = (value) => {
        if (value === 0) return 0;
        const magnitude = Math.pow(10, Math.floor(Math.log10(value)));
        const normalized = value / magnitude;
        let nice;
        if (normalized <= 1) nice = 1;
        else if (normalized <= 2) nice = 2;
        else if (normalized <= 5) nice = 5;
        else nice = 10;
        return nice * magnitude;
      };
      
      const niceMax = getNiceNumber(maxReq);
      const usableHeight = chartHeight * Y_AXIS_USABLE_HEIGHT_RATIO;
      
      for (let i = 0; i <= numYTicks; i++) {
        const value = (niceMax / numYTicks) * i;
        const y = chartHeight - (usableHeight * i / numYTicks);
        
        // Tick mark
        const tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        tick.setAttribute('x1', -5);
        tick.setAttribute('y1', y);
        tick.setAttribute('x2', 0);
        tick.setAttribute('y2', y);
        tick.setAttribute('stroke', 'var(--border)');
        tick.setAttribute('stroke-width', 1);
        g.appendChild(tick);
        
        // Label - use helper function for consistent formatting
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', -10);
        label.setAttribute('y', y + 4);
        label.setAttribute('text-anchor', 'end');
        label.setAttribute('fill', 'var(--muted)');
        label.setAttribute('font-size', '11');
        label.textContent = formatChartValue(value);
        g.appendChild(label);
      }
      
      // Draw bars
      const points = data.timestamps.length;
      const barWidth = (chartWidth / points) * 0.8; // 80% width to add spacing
      const barSpacing = (chartWidth / points) * 0.2;
      
      // Requests bars (green)
      for (let i = 0; i < points; i++) {
        const x = (i * chartWidth / points) + (barSpacing / 2);
        const requestValue = data.requests_per_min[i];
        // Scale bars against niceMax to align with Y-axis scale
        const barHeight = (requestValue / niceMax * usableHeight);
        const y = chartHeight - barHeight;
        
        const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        bar.setAttribute('x', x);
        bar.setAttribute('y', y);
        bar.setAttribute('width', barWidth);
        bar.setAttribute('height', barHeight);
        bar.setAttribute('fill', 'var(--ok)');
        bar.setAttribute('opacity', '0.7');
        
        // Add tooltip with timestamp and value
        const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
        const timestampStr = formatTimestamp(data.timestamps[i], 'full');
        // Request counts are discrete, display as whole numbers
        title.textContent = `${timestampStr}\nRequests: ${Math.round(requestValue)}/min`;
        bar.appendChild(title);
        
        g.appendChild(bar);
        
        // Add value label on top of bar (only if bar is tall enough and value > 0)
        if (barHeight > 15 && requestValue > 0) {
          const valueLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          valueLabel.setAttribute('x', x + barWidth / 2);
          valueLabel.setAttribute('y', y - 5);
          valueLabel.setAttribute('text-anchor', 'middle');
          valueLabel.setAttribute('fill', 'var(--muted)');
          valueLabel.setAttribute('font-size', '10');
          valueLabel.setAttribute('font-weight', 'bold');
          // Request counts are discrete, display as whole numbers
          valueLabel.textContent = Math.round(requestValue);
          g.appendChild(valueLabel);
        }
      }
      
      // X-axis time labels (show every nth label to avoid crowding)
      const numXLabels = Math.min(10, points); // Show at most 10 labels
      const labelStep = Math.max(1, Math.floor(points / numXLabels));
      
      for (let i = 0; i < points; i += labelStep) {
        const x = (i * chartWidth / points) + (barSpacing / 2) + (barWidth / 2);
        
        // Use helper function for consistent timestamp formatting
        const timeLabel = formatTimestamp(data.timestamps[i], 'time');
        
        if (timeLabel) {
          const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          label.setAttribute('x', x);
          label.setAttribute('y', chartHeight + 20);
          label.setAttribute('text-anchor', 'middle');
          label.setAttribute('fill', 'var(--muted)');
          label.setAttribute('font-size', '10');
          label.textContent = timeLabel;
          g.appendChild(label);
        }
      }
      
      // Legend
      const legend = [
        { color: 'var(--ok)', label: 'Requests/min' }
      ];
      
      let legendX = chartWidth - 150;
      for (let i = 0; i < legend.length; i++) {
        const item = legend[i];
        const y = 15 + i * 20;
        
        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', legendX);
        rect.setAttribute('y', y - 10);
        rect.setAttribute('width', 20);
        rect.setAttribute('height', 12);
        rect.setAttribute('fill', item.color);
        rect.setAttribute('opacity', '0.7');
        g.appendChild(rect);
        
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', legendX + 25);
        text.setAttribute('y', y);
        text.setAttribute('fill', 'var(--muted)');
        text.setAttribute('font-size', '12');
        text.textContent = item.label;
        g.appendChild(text);
      }
      
      svg.appendChild(g);
    }
    
    // Refresh dashboard
    function refreshDashboard() {
      updateOverview();
      updateTimeSeries();
    }
    
    // Auto-refresh
    let overviewInterval, timeseriesInterval;
    
    function startAutoRefresh() {
      // Initial load
      refreshDashboard();
      
      // Overview every 5 seconds
      overviewInterval = setInterval(updateOverview, 5000);
      
      // Timeseries every 15 seconds
      timeseriesInterval = setInterval(updateTimeSeries, 15000);
    }
    
    // Start on load
    if (SECURITY_TOKEN) {
      startAutoRefresh();
    } else {
      showError('Please enter and save your security token to view the dashboard');
    }
  </script>
</body>
</html>
